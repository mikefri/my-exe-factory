<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web2Exe Cloud Factory</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        :root {
            --primary-start: #4CAF50; 
            --primary-end: #8BC34A; 
            --bg-dark: #1a1a2e; 
            --card-bg-light: rgba(255, 255, 255, 0.08); 
            --text-light: #e0e0e0;
            --text-muted: #b0b0b0;
            --border-color: rgba(255, 255, 255, 0.15);
            --error-color: #EF5350; 
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f1d 100%);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .container {
            background-color: var(--card-bg-light);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            padding: 2.5rem;
            text-align: center;
            max-width: 450px;
            width: 90%;
            position: relative;
        }

        h1 { color: white; margin-bottom: 0.7rem; font-weight: 600; }
        p { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 2.5rem; }

        .upload-area {
            border: 2px dashed var(--border-color);
            padding: 2.5rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover { border-color: var(--primary-end); background-color: rgba(255, 255, 255, 0.05); }

        input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        .file-label { display: block; color: var(--text-muted); font-size: 0.9rem; }
        .file-label strong { color: var(--text-light); }

        .progress-container {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            height: 14px;
            margin: 25px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--primary-start) 0%, var(--primary-end) 100%);
            width: 0%; height: 100%;
            transition: width 0.6s ease-out;
        }

        button {
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            color: white; border: none; padding: 14px 28px; border-radius: 10px;
            font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s;
        }

        button:disabled { background: #2b2b3f; cursor: not-allowed; color: #6a6a7a; }

        .btn-download {
            display: block; margin-top: 20px; padding: 16px;
            background: #2563eb; color: white; text-decoration: none;
            border-radius: 10px; font-weight: 600; transition: 0.3s;
        }
        .btn-download:hover { background: #1d4ed8; transform: translateY(-2px); }
        
        #status { margin-top: 20px; font-size: 0.9rem; color: var(--text-muted); }
    </style>
</head>
<body>

<div class="container">
    <h1>Usine √† .EXE üöÄ</h1>
    <p>Transformez n'importe quel site web (ZIP) en application Windows portable.</p>

    <div class="upload-area" id="dropZone">
        <input type="file" id="fileInput" accept=".zip">
        <span id="fileLabel" class="file-label">üì• Glissez ou <strong>cliquez</strong> pour s√©lectionner votre ZIP</span>
    </div>

    <div id="progressContainer" class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
    </div>

    <button id="btn" onclick="lancerProcessus()">Lancer la fabrication</button>

    <div id="status">Pr√™t √† d√©marrer.</div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const fileLabel = document.getElementById('fileLabel');
    const btn = document.getElementById('btn');
    const statusDiv = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.getElementById('progressContainer');

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            fileLabel.innerHTML = `üì¶ Fichier s√©lectionn√© : <strong>${fileInput.files[0].name}</strong>`;
            btn.disabled = false;
        }
    });

    btn.disabled = true;

    function updateProgress(percent, message, isError = false) {
        progressBar.style.width = percent + "%";
        statusDiv.innerHTML = message;
        if (isError) progressBar.style.background = "var(--error-color)";
    }

    async function lancerProcessus() {
        const file = fileInput.files[0];
        if (!file) return;

        btn.disabled = true;
        progressContainer.style.display = "block";
        updateProgress(5, "‚è≥ Pr√©paration du fichier..."); 

        try {
            // √âTAPE 1 : Upload
            updateProgress(15, "‚òÅÔ∏è √âtape 1/3 : H√©bergement du ZIP...");
            const formData = new FormData();
            formData.append('file', file);
            const uploadRes = await fetch('https://tmpfiles.org/api/v1/upload', { method: 'POST', body: formData });
            
            if (!uploadRes.ok) throw new Error("Erreur lors de l'h√©bergement.");
            const uploadData = await uploadRes.json();
            // Conversion forc√©e en lien de t√©l√©chargement direct
            const publicZipUrl = uploadData.data.url.replace('https://tmpfiles.org/', 'https://tmpfiles.org/dl/');

            // √âTAPE 2 : GitHub Action
            updateProgress(45, "üöÄ √âtape 2/3 : Lancement de l'usine GitHub...");
            const githubRes = await fetch('/api/run-build', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ zip_url: publicZipUrl })
            });

            if (!githubRes.ok) throw new Error("√âchec du lancement GitHub.");

            // √âTAPE 3 : Attente avec v√©rification de statut
            updateProgress(70, "üèóÔ∏è √âtape 3/3 : Compilation du .EXE (veuillez patienter)...");
            
            // On attend 5 secondes avant la premi√®re v√©rification pour laisser GitHub d√©marrer
            setTimeout(() => {
                const checkInterval = setInterval(async () => {
                    try {
                        const checkRes = await fetch('/api/check-build');
                        const checkData = await checkRes.json();

                        // Si l'API dit 'success' et donne une URL
                        if (checkData.status === 'success' && checkData.url) {
                            clearInterval(checkInterval);
                            updateProgress(100, "‚úÖ Votre application est pr√™te !");
                            statusDiv.innerHTML = `<a href="${checkData.url}" class="btn-download">‚¨áÔ∏è T√âL√âCHARGER LE .EXE</a>`;
                            btn.style.display = 'none';
                        } 
                        else if (checkData.status === 'building') {
                            // On simule une progression lente pendant le build
                            let currentWidth = parseFloat(progressBar.style.width);
                            if (currentWidth < 98) progressBar.style.width = (currentWidth + 0.5) + "%";
                            statusDiv.innerHTML = "üèóÔ∏è Compilation en cours sur les serveurs GitHub...";
                        }
                    } catch (e) {
                        console.log("Attente du serveur...");
                    }
                }, 8000); // V√©rification toutes les 8 secondes
            }, 5000);

        } catch (error) {
            updateProgress(100, `‚ùå Erreur : ${error.message}`, true);
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
