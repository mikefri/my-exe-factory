<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web2Exe Cloud Factory</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        :root {
            --primary-start: #4CAF50; 
            --primary-end: #8BC34A; 
            --bg-dark: #1a1a2e; 
            --card-bg-light: rgba(255, 255, 255, 0.08); 
            --text-light: #e0e0e0;
            --text-muted: #b0b0b0;
            --border-color: rgba(255, 255, 255, 0.15);
            --error-color: #EF5350; 
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f1d 100%);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        @keyframes containerPulse {
            0% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); border-color: var(--border-color); }
            50% { box-shadow: 0 0 25px rgba(76, 175, 80, 0.2); border-color: rgba(76, 175, 80, 0.4); }
            100% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); border-color: var(--border-color); }
        }

        .container {
            background-color: var(--card-bg-light);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 2.5rem;
            text-align: center;
            max-width: 480px;
            width: 100%;
        }

        .container.processing { animation: containerPulse 3s infinite ease-in-out; }

        h1 { color: white; margin-bottom: 0.5rem; font-weight: 600; font-size: 1.8rem; }
        .subtitle { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 2rem; }

        /* ChronomÃ¨tre */
        .timer-display {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem;
            color: var(--primary-end);
            margin-bottom: 10px;
            display: none;
            font-weight: bold;
        }

        .steps-container {
            text-align: left;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 20px;
            display: none;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .step.active { color: white; font-weight: 600; transform: translateX(5px); }
        .step.done { color: var(--primary-end); }

        .bullet {
            width: 20px; height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            flex-shrink: 0;
        }

        .step.active .bullet { 
            border-color: var(--primary-end); 
            background: var(--primary-end);
            box-shadow: 0 0 10px var(--primary-end);
        }
        
        .step.done .bullet::before { content: "âœ“"; font-weight: bold; }

        .upload-area {
            border: 2px dashed var(--border-color);
            padding: 2.5rem 1rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            cursor: pointer;
            position: relative;
        }

        .progress-container {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            height: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(90deg, var(--primary-start), var(--primary-end));
            width: 0%; height: 100%;
            transition: width 0.5s ease;
        }

        .spinner {
            display: inline-block;
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--primary-end);
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        button {
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            color: white; border: none; padding: 16px; border-radius: 12px;
            font-weight: 600; cursor: pointer; width: 100%; font-size: 1rem;
        }
        button:disabled { background: #2b2b3f; cursor: not-allowed; color: #6a6a7a; }

        .btn-download {
            display: block; padding: 16px;
            background: #2563eb; color: white; text-decoration: none;
            border-radius: 12px; font-weight: 600; text-align: center;
        }
    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <h1>Usine Ã  .EXE ðŸš€</h1>
    <p class="subtitle">Compilation Cloud en temps rÃ©el.</p>

    <div class="timer-display" id="timer">00:00</div>

    <div class="upload-area" id="dropZone">
        <input type="file" id="fileInput" accept=".zip">
        <span id="fileLabel">ðŸ“¥ SÃ©lectionnez votre ZIP pour commencer</span>
    </div>

    <div class="steps-container" id="stepsContainer">
        <div class="step" id="step1"><div class="bullet"></div> 1. Upload du projet</div>
        <div class="step" id="step2"><div class="bullet"></div> 2. Initialisation GitHub</div>
        <div class="step" id="step3"><div class="bullet"></div> 3. Extraction des sources</div>
        <div class="step" id="step4"><div class="bullet"></div> 4. Configuration icÃ´ne/nom</div>
        <div class="step" id="step5"><div class="bullet"></div> 5. PrÃ©paration environnement</div>
        <div class="step" id="step6"><div class="bullet"></div> 6. Installation dÃ©pendances</div>
        <div class="step" id="step7"><div class="bullet"></div> 7. Compilation binaire (.exe)</div>
        <div class="step" id="step8"><div class="bullet"></div> 8. Finalisation du package</div>
        <div class="step" id="step9"><div class="bullet"></div> 9. DÃ©ploiement de la release</div>
    </div>

    <div id="progressContainer" class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
    </div>

    <button id="btn" onclick="lancerProcessus()">DÃ©marrer la fabrication</button>

    <div id="status" style="margin-top:20px; font-size:0.9rem; color:var(--text-muted);">
        <span id="spinnerContainer" style="display:none;"><div class="spinner"></div></span>
        <span id="statusText">PrÃªt.</span>
    </div>
</div>

<script>
    let startTime;
    let timerInterval;

    const fileInput = document.getElementById('fileInput');
    const btn = document.getElementById('btn');
    const statusText = document.getElementById('statusText');
    const timerDisplay = document.getElementById('timer');
    const progressBar = document.getElementById('progressBar');
    const mainContainer = document.getElementById('mainContainer');

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            document.getElementById('fileLabel').innerHTML = `ðŸ“¦ <strong>${fileInput.files[0].name}</strong>`;
            btn.disabled = false;
        }
    });

    btn.disabled = true;

    function startTimer() {
        startTime = Date.now();
        timerDisplay.style.display = 'block';
        timerInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            timerDisplay.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }

    function setStep(num, state) {
        const el = document.getElementById(`step${num}`);
        if (el) {
            el.classList.remove('active', 'done');
            if (state === 'active') el.classList.add('active');
            if (state === 'done') el.classList.add('done');
        }
    }

    async function lancerProcessus() {
        startTimer();
        btn.style.display = 'none';
        mainContainer.classList.add('processing');
        document.getElementById('spinnerContainer').style.display = 'inline-block';
        document.getElementById('stepsContainer').style.display = 'block';
        document.getElementById('progressContainer').style.display = 'block';

        try {
            setStep(1, 'active');
            statusText.innerText = "TÃ©lÃ©chargement vers le serveur...";
            
            // Simulation des appels API (Ã  remplacer par vos vrais fetch)
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            const uploadRes = await fetch('https://tmpfiles.org/api/v1/upload', { method: 'POST', body: formData });
            const uploadData = await uploadRes.json();
            const publicUrl = uploadData.data.url.replace('https://tmpfiles.org/', 'https://tmpfiles.org/dl/');
            setStep(1, 'done');

            setStep(2, 'active');
            statusText.innerText = "Lancement de l'usine GitHub...";
            const githubRes = await fetch('/api/run-build', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ zip_url: publicUrl })
            });
            setStep(2, 'done');

            // Boucle de vÃ©rification
            let currentCompStep = 3;
            setStep(currentCompStep, 'active');

            const check = setInterval(async () => {
                const res = await fetch('/api/check-build');
                const data = await res.json();

                if (data.status === 'success') {
                    clearInterval(check);
                    clearInterval(timerInterval);
                    for(let i=3; i<=9; i++) setStep(i, 'done');
                    progressBar.style.width = "100%";
                    mainContainer.classList.remove('processing');
                    document.getElementById('spinnerContainer').style.display = 'none';
                    statusText.innerHTML = `<a href="${data.url}" class="btn-download">ðŸ’¾ TÃ‰LÃ‰CHARGER LE .EXE</a>`;
                } else {
                    if (currentCompStep < 8) {
                        setStep(currentCompStep, 'done');
                        currentCompStep++;
                        setStep(currentCompStep, 'active');
                        progressBar.style.width = (20 + (currentCompStep * 9)) + "%";
                        statusText.innerText = `Travail en cours...`;
                    }
                }
            }, 10000);

        } catch (e) {
            statusText.innerText = "Erreur fatale.";
            clearInterval(timerInterval);
        }
    }
</script>
</body>
</html>
