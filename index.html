<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web2Exe Cloud Factory</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        :root {
            --primary-start: #4CAF50; 
            --primary-end: #8BC34A; 
            --bg-dark: #1a1a2e; 
            --card-bg-light: rgba(255, 255, 255, 0.08); 
            --text-light: #e0e0e0;
            --text-muted: #b0b0b0;
            --border-color: rgba(255, 255, 255, 0.15);
            --error-color: #EF5350; 
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f1d 100%);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: var(--card-bg-light);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            padding: 2rem;
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        h1 { color: white; margin-bottom: 0.5rem; font-weight: 600; font-size: 1.8rem; }
        .subtitle { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem; }

        /* Checklist des √©tapes */
        .steps-container {
            text-align: left;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: none; /* Cach√© au d√©but */
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            transition: 0.3s;
        }

        .step.active { color: var(--text-light); font-weight: 600; }
        .step.done { color: var(--primary-end); }
        .step.done .bullet::before { content: "‚úì"; color: var(--primary-end); }

        .bullet {
            width: 18px; height: 18px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            flex-shrink: 0;
        }

        .step.active .bullet { border-color: var(--primary-end); box-shadow: 0 0 8px var(--primary-end); }

        /* Reste du style existant */
        .upload-area {
            border: 2px dashed var(--border-color);
            padding: 2rem 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            cursor: pointer;
            position: relative;
        }
        .upload-area:hover { border-color: var(--primary-end); background-color: rgba(255, 255, 255, 0.05); }
        input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        
        .progress-container {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            height: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(90deg, var(--primary-start) 0%, var(--primary-end) 100%);
            width: 0%; height: 100%;
            transition: width 0.4s ease;
        }

        button {
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            color: white; border: none; padding: 14px; border-radius: 10px;
            font-weight: 600; cursor: pointer; width: 100%; transition: 0.3s;
        }
        button:disabled { background: #2b2b3f; cursor: not-allowed; color: #6a6a7a; }

        .btn-download {
            display: block; margin-top: 20px; padding: 16px;
            background: #2563eb; color: white; text-decoration: none;
            border-radius: 10px; font-weight: 600; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="container">
    <h1>Usine √† .EXE üöÄ</h1>
    <p class="subtitle">Suivi en temps r√©el de la fabrication cloud.</p>

    <div class="upload-area" id="dropZone">
        <input type="file" id="fileInput" accept=".zip">
        <span id="fileLabel" class="file-label">üì• Glissez ou <strong>cliquez</strong> pour votre ZIP</span>
    </div>

    <div class="steps-container" id="stepsContainer">
        <div class="step" id="step1"><div class="bullet"></div> 1. R√©ception du ZIP</div>
        <div class="step" id="step2"><div class="bullet"></div> 2. Pr√©paration Node.js</div>
        <div class="step" id="step3"><div class="bullet"></div> 3. T√©l√©chargement et Extraction</div>
        <div class="step" id="step4"><div class="bullet"></div> 4. R√©cup√©ration de l'ic√¥ne</div>
        <div class="step" id="step5"><div class="bullet"></div> 5. Injection du nom personnalis√©</div>
        <div class="step" id="step6"><div class="bullet"></div> 6. Installation des d√©pendances</div>
        <div class="step" id="step7"><div class="bullet"></div> 7. Compilation Electron (.EXE)</div>
        <div class="step" id="step8"><div class="bullet"></div> 8. Pr√©paration du fichier final</div>
        <div class="step" id="step9"><div class="bullet"></div> 9. Cr√©ation de la Release</div>
    </div>

    <div id="progressContainer" class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
    </div>

    <button id="btn" onclick="lancerProcessus()">Lancer la fabrication</button>

    <div id="status" style="margin-top:15px; font-size:0.85rem; color:var(--text-muted);">Pr√™t √† d√©marrer.</div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const btn = document.getElementById('btn');
    const statusDiv = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const stepsContainer = document.getElementById('stepsContainer');

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            document.getElementById('fileLabel').innerHTML = `üì¶ <strong>${fileInput.files[0].name}</strong>`;
            btn.disabled = false;
        }
    });

    btn.disabled = true;

    function setStep(stepNumber, state) {
        const stepEl = document.getElementById(`step${stepNumber}`);
        if (!stepEl) return;
        
        // Nettoyer les classes
        stepEl.classList.remove('active', 'done');
        
        if (state === 'active') {
            stepEl.classList.add('active');
            stepEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else if (state === 'done') {
            stepEl.classList.add('done');
        }
    }

    async function lancerProcessus() {
        const file = fileInput.files[0];
        if (!file) return;

        btn.style.display = 'none';
        stepsContainer.style.display = 'block';
        document.getElementById('progressContainer').style.display = 'block';

        try {
            // √âTAPE 1 : Upload
            setStep(1, 'active');
            const formData = new FormData();
            formData.append('file', file);
            const uploadRes = await fetch('https://tmpfiles.org/api/v1/upload', { method: 'POST', body: formData });
            if (!uploadRes.ok) throw new Error("√âchec de l'upload.");
            const uploadData = await uploadRes.json();
            const publicZipUrl = uploadData.data.url.replace('https://tmpfiles.org/', 'https://tmpfiles.org/dl/');
            setStep(1, 'done');

            // √âTAPE 2 : Activation GitHub
            setStep(2, 'active');
            const githubRes = await fetch('/api/run-build', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ zip_url: publicZipUrl })
            });
            if (!githubRes.ok) throw new Error("GitHub ne r√©pond pas.");
            setStep(2, 'done');

            // Simulation du suivi des √©tapes 3 √† 9
            // Dans un syst√®me r√©el, check-build devrait renvoyer l'√©tape actuelle.
            // Ici, nous faisons progresser visuellement en fonction du temps moyen de build.
            let currentStep = 3;
            setStep(3, 'active');
            progressBar.style.width = "30%";

            const checkInterval = setInterval(async () => {
                try {
                    const checkRes = await fetch('/api/check-build');
                    const checkData = await checkRes.json();

                    if (checkData.status === 'success' && checkData.url) {
                        clearInterval(checkInterval);
                        // Tout marquer comme termin√©
                        for(let i=3; i<=9; i++) setStep(i, 'done');
                        progressBar.style.width = "100%";
                        statusDiv.innerHTML = `<a href="${checkData.url}" class="btn-download">‚¨áÔ∏è T√âL√âCHARGER LE .EXE</a>`;
                    } else {
                        // Progression logique simul√©e pour les √©tapes de build
                        if (currentStep < 8) {
                            setStep(currentStep, 'done');
                            currentStep++;
                            setStep(currentStep, 'active');
                            progressBar.style.width = (30 + (currentStep * 8)) + "%";
                        }
                    }
                } catch (e) { console.log("Attente..."); }
            }, 10000); // On change d'√©tape visuelle toutes les 10s environ

        } catch (error) {
            statusDiv.innerHTML = `<b style="color:var(--error-color)">‚ùå Erreur : ${error.message}</b>`;
            btn.style.display = 'block';
        }
    }
</script>
</body>
</html>
